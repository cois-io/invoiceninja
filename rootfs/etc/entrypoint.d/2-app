#!/bin/bash

declare -x INVOICENINJA_APP_ENV
declare -x INVOICENINJA_APP_DEBUG
declare -x INVOICENINJA_APP_URL
declare -x INVOICENINJA_APP_CIPHER
declare -x INVOICENINJA_APP_KEY
declare -x INVOICENINJA_DB_TYPE
declare -x INVOICENINJA_DB_STRICT
declare -x INVOICENINJA_DB_HOST
declare -x INVOICENINJA_DB_DATABASE
declare -x INVOICENINJA_DB_USERNAME
declare -x INVOICENINJA_DB_PASSWORD
declare -x INVOICENINJA_MAIL_DRIVER
declare -x INVOICENINJA_MAIL_PORT
declare -x INVOICENINJA_MAIL_ENCRYPTION
declare -x INVOICENINJA_MAIL_HOST
declare -x INVOICENINJA_MAIL_USERNAME
declare -x INVOICENINJA_MAIL_FROM_ADDRESS
declare -x INVOICENINJA_MAIL_FROM_NAME
declare -x INVOICENINJA_MAIL_PASSWORD
declare -x INVOICENINJA_PHANTOMJS_CLOUD_KEY
declare -x INVOICENINJA_LOG
declare -x INVOICENINJA_REQUIRE_HTTPS
declare -x INVOICENINJA_GITHUB_CLIENT_ID
declare -x INVOICENINJA_GITHUB_CLIENT_SECRET
declare -x INVOICENINJA_GOOGLE_CLIENT_ID
declare -x INVOICENINJA_GOOGLE_CLIENT_SECRET
declare -x INVOICENINJA_FACEBOOK_CLIENT_ID
declare -x INVOICENINJA_FACEBOOK_CLIENT_SECRET
declare -x INVOICENINJA_LINKEDIN_CLIENT_ID
declare -x INVOICENINJA_LINKEDIN_CLIENT_SECRET

[[ -z "${INVOICENINJA_APP_ENV}" ]] && INVOICENINJA_APP_ENV="production"
[[ -z "${INVOICENINJA_APP_DEBUG}" ]] && INVOICENINJA_APP_DEBUG="false"
[[ -z "${INVOICENINJA_APP_URL}" ]] && INVOICENINJA_APP_URL="http://localhost"
[[ -z "${INVOICENINJA_APP_CIPHER}" ]] && INVOICENINJA_APP_CIPHER="rijndael-128"
[[ -z "${INVOICENINJA_DB_TYPE}" ]] && INVOICENINJA_DB_TYPE="mysql"
[[ -z "${INVOICENINJA_DB_STRICT}" ]] && INVOICENINJA_DB_STRICT="false"
[[ -z "${INVOICENINJA_DB_HOST}" ]] && INVOICENINJA_DB_HOST="mysql"
[[ -z "${INVOICENINJA_DB_DATABASE}" ]] && INVOICENINJA_DB_DATABASE="ninja"
[[ -z "${INVOICENINJA_DB_USERNAME}" ]] && INVOICENINJA_DB_USERNAME="root"
[[ -z "${INVOICENINJA_DB_PASSWORD}" ]] && INVOICENINJA_DB_PASSWORD="root"
[[ -z "${INVOICENINJA_MAIL_DRIVER}" ]] && INVOICENINJA_MAIL_DRIVER="smtp"
[[ -z "${INVOICENINJA_MAIL_PORT}" ]] && INVOICENINJA_MAIL_PORT="587"
[[ -z "${INVOICENINJA_MAIL_ENCRYPTION}" ]] && INVOICENINJA_MAIL_ENCRYPTION="tls"
[[ -z "${INVOICENINJA_LOG}" ]] && INVOICENINJA_LOG="single"
[[ -z "${INVOICENINJA_REQUIRE_HTTPS}" ]] && INVOICENINJA_REQUIRE_HTTPS="false"

if [ -z "${INVOICENINJA_APP_KEY}" ]
then
  if [ -f /var/lib/invoiceninja/secret ]
  then
    INVOICENINJA_APP_KEY=$(cat /var/lib/invoiceninja/secret | head -n1)
  else
    INVOICENINJA_APP_KEY=$(date +%s | sha256sum | base64 | head -c 32 ; echo)
    echo "${INVOICENINJA_APP_KEY}" > /var/lib/invoiceninja/secret
  fi
fi

/usr/bin/templater -d -p invoiceninja \
  -o /app/.env \
  /etc/templates/env.tmpl

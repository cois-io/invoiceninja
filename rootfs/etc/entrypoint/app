#!/bin/bash

declare -x INVOICENINJA_APP_ENV
declare -x INVOICENINJA_APP_DEBUG
declare -x INVOICENINJA_APP_URL
declare -x INVOICENINJA_APP_CIPHER
declare -x INVOICENINJA_APP_KEY
declare -x INVOICENINJA_APP_TIMEZONE
declare -x INVOICENINJA_APP_LOCALE
declare -x INVOICENINJA_DB_TYPE
declare -x INVOICENINJA_DB_STRICT
declare -x INVOICENINJA_DB_HOST
declare -x INVOICENINJA_DB_DATABASE
declare -x INVOICENINJA_DB_USERNAME
declare -x INVOICENINJA_DB_PASSWORD
declare -x INVOICENINJA_MAIL_DRIVER
declare -x INVOICENINJA_MAIL_PORT
declare -x INVOICENINJA_MAIL_ENCRYPTION
declare -x INVOICENINJA_MAIL_HOST
declare -x INVOICENINJA_MAIL_USERNAME
declare -x INVOICENINJA_MAIL_ADDRESS
declare -x INVOICENINJA_MAIL_NAME
declare -x INVOICENINJA_MAIL_PASSWORD
declare -x INVOICENINJA_PHANTOMJS_CLOUD_KEY
declare -x INVOICENINJA_LOG
declare -x INVOICENINJA_REQUIRE_HTTPS
declare -x INVOICENINJA_GITHUB_CLIENT_ID
declare -x INVOICENINJA_GITHUB_CLIENT_SECRET
declare -x INVOICENINJA_GOOGLE_CLIENT_ID
declare -x INVOICENINJA_GOOGLE_CLIENT_SECRET
declare -x INVOICENINJA_FACEBOOK_CLIENT_ID
declare -x INVOICENINJA_FACEBOOK_CLIENT_SECRET
declare -x INVOICENINJA_LINKEDIN_CLIENT_ID
declare -x INVOICENINJA_LINKEDIN_CLIENT_SECRET

[[ -z "${INVOICENINJA_APP_ENV}" ]] && INVOICENINJA_APP_ENV="production"
[[ -z "${INVOICENINJA_APP_DEBUG}" ]] && INVOICENINJA_APP_DEBUG="false"
[[ -z "${INVOICENINJA_APP_URL}" ]] && INVOICENINJA_APP_URL="http://localhost"
[[ -z "${INVOICENINJA_APP_CIPHER}" ]] && INVOICENINJA_APP_CIPHER="rijndael-128"
[[ -z "${INVOICENINJA_APP_TIMEZONE}" ]] && INVOICENINJA_APP_TIMEZONE="UTC"
[[ -z "${INVOICENINJA_APP_LOCALE}" ]] && INVOICENINJA_APP_LOCALE="en"
[[ -z "${INVOICENINJA_MAIL_DRIVER}" ]] && INVOICENINJA_MAIL_DRIVER="smtp"
[[ -z "${INVOICENINJA_MAIL_PORT}" ]] && INVOICENINJA_MAIL_PORT="587"
[[ -z "${INVOICENINJA_MAIL_ENCRYPTION}" ]] && INVOICENINJA_MAIL_ENCRYPTION="tls"
[[ -z "${INVOICENINJA_MAIL_ADDRESS}" ]] && INVOICENINJA_MAIL_ADDRESS="invoiceninja@localhost"
[[ -z "${INVOICENINJA_MAIL_NAME}" ]] && INVOICENINJA_MAIL_NAME="Invoiceninja"
[[ -z "${INVOICENINJA_LOG}" ]] && INVOICENINJA_LOG="single"
[[ -z "${INVOICENINJA_REQUIRE_HTTPS}" ]] && INVOICENINJA_REQUIRE_HTTPS="false"
[[ -z "${INVOICENINJA_DB_TYPE}" ]] && INVOICENINJA_DB_TYPE="mysql"

case "${INVOICENINJA_DB_TYPE}" in
  "sqlite")
    declare -x INVOICENINJA_DB_DATABASE
    declare -x INVOICENINJA_DB_PREFIX

    [[ -z "${INVOICENINJA_DB_DATABASE}" ]] && INVOICENINJA_DB_DATABASE="/storage/database.sqlite3"
    ;;

  "mysql")
    declare -x INVOICENINJA_DB_HOST
    declare -x INVOICENINJA_DB_DATABASE
    declare -x INVOICENINJA_DB_USERNAME
    declare -x INVOICENINJA_DB_PASSWORD
    declare -x INVOICENINJA_DB_PREFIX
    declare -x INVOICENINJA_DB_CHARSET
    declare -x INVOICENINJA_DB_COLLATION
    declare -x INVOICENINJA_DB_STRICT

    [[ -z "${INVOICENINJA_DB_HOST}" ]] && INVOICENINJA_DB_HOST="mysql"
    [[ -z "${INVOICENINJA_DB_DATABASE}" ]] && INVOICENINJA_DB_DATABASE="ninja"
    [[ -z "${INVOICENINJA_DB_USERNAME}" ]] && INVOICENINJA_DB_USERNAME="root"
    [[ -z "${INVOICENINJA_DB_PASSWORD}" ]] && INVOICENINJA_DB_PASSWORD="root"
    [[ -z "${INVOICENINJA_DB_CHARSET}" ]] && INVOICENINJA_DB_CHARSET="utf8"
    [[ -z "${INVOICENINJA_DB_COLLATION}" ]] && INVOICENINJA_DB_COLLATION="utf8_general_ci"
    [[ -z "${INVOICENINJA_DB_STRICT}" ]] && INVOICENINJA_DB_STRICT="false"
    ;;

  "pgsql")
    declare -x INVOICENINJA_DB_HOST
    declare -x INVOICENINJA_DB_DATABASE
    declare -x INVOICENINJA_DB_USERNAME
    declare -x INVOICENINJA_DB_PASSWORD
    declare -x INVOICENINJA_DB_PREFIX
    declare -x INVOICENINJA_DB_CHARSET
    declare -x INVOICENINJA_DB_SCHEMA

    [[ -z "${INVOICENINJA_DB_HOST}" ]] && INVOICENINJA_DB_HOST="postgres"
    [[ -z "${INVOICENINJA_DB_DATABASE}" ]] && INVOICENINJA_DB_DATABASE="ninja"
    [[ -z "${INVOICENINJA_DB_USERNAME}" ]] && INVOICENINJA_DB_USERNAME="root"
    [[ -z "${INVOICENINJA_DB_PASSWORD}" ]] && INVOICENINJA_DB_PASSWORD="root"
    [[ -z "${INVOICENINJA_DB_CHARSET}" ]] && INVOICENINJA_DB_CHARSET="utf8"
    [[ -z "${INVOICENINJA_DB_SCHEMA}" ]] && INVOICENINJA_DB_SCHEMA="public"
    ;;
esac

if [ -z "${INVOICENINJA_APP_KEY}" ]
then
  if [ -f /storage/secret ]
  then
    INVOICENINJA_APP_KEY=$(cat /storage/secret | head -n1)
  else
    INVOICENINJA_APP_KEY=$(date +%s | sha256sum | base64 | head -c 32 ; echo)
    echo "${INVOICENINJA_APP_KEY}" > /storage/secret
  fi
fi
